#include "oled.h"
#include <stdint.h>
#include <xc.h> 
#define OLED_ADDRESS 0x3C 
//bitmap

//heart
//record which heart to print
int which_heart = 1;
const uint8_t heart1[] = {0xF0, 0x00, 0x08, 0x01, 0x04, 0x06, 0x02, 0x18, 0x02, 0x20, 0x04, 0x40, 0x08, 0x40, 0x10, 0x80, 0x10, 0x80, 0x08, 0x40, 0x04, 0x40, 0x02, 0x20, 0x02, 0x18, 0x04, 0x06, 0x08, 0x01, 0xF0, 0x00};
const uint8_t heart2[] = {0x00, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x10, 0x03, 0x08, 0x04, 0x08, 0x08, 0x10, 0x10, 0x20, 0x20, 0x20, 0x20, 0x10, 0x10, 0x08, 0x08, 0x08, 0x04, 0x10, 0x03, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00};

//foots
const uint8_t foots[] = {0x40, 0x00, 0x18, 0x00, 0xD8, 0x01, 0xE6, 0x03, 0xF6, 0x0F, 0xF0, 0x1F, 0xF7, 0x1F, 0xF7, 0x39, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x1C, 0xE0, 0x9C, 0xF1, 0xDC, 0x7B, 0xE0, 0x3F, 0xEC, 0x1F, 0xCC, 0x0F, 0x80, 0x03, 0x18, 0x00, 0x58, 0x00};

//for clock
const uint8_t clock[] = {0x00, 0x00, 0x80, 0x07, 0x60, 0x18, 0x10, 0x20, 0x08, 0x40, 0x08, 0x40, 0x04, 0x80, 0xE7, 0x83, 0x07, 0x82, 0x04, 0x82, 0x08, 0x42, 0x08, 0x40, 0x10, 0x20, 0x60, 0x18, 0x80, 0x07, 0x00, 0x00};
const uint8_t dots[] = {0x00, 0x00, 0x00, 0x00, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x00, 0x00, 0x00, 0x00};

//for temperature
const uint8_t thermometer[] = {0x00, 0x7F, 0x80, 0x80, 0x80, 0x80, 0x80, 0x98, 0x00, 0x99, 0x80, 0x84, 0x40, 0x82, 0x20, 0x89, 0x90, 0x74, 0x08, 0x02, 0x04, 0x01, 0x82, 0x00, 0x41, 0x00, 0x21, 0x00, 0x11, 0x00, 0x0F, 0x00};
const uint8_t temp[] = {0x3C, 0x00, 0x3C, 0x00, 0xC3, 0x00, 0xC3, 0x00, 0xC3, 0x00, 0xC3, 0x00, 0x3C, 0x00, 0x3C, 0x1F, 0x80, 0x31, 0xC0, 0x60, 0x60, 0xC0, 0x60, 0xC0, 0x60, 0xC0, 0xC0, 0x60, 0x80, 0x31, 0x00, 0x00};

//character
//number
const uint8_t number[][24] = {
    //0
    {0xF0, 0x0F, 0xFC, 0x3F, 0x0E, 0x70, 0x03, 0xC0, 0x03, 0xC0, 0x03, 0xC0, 0x03, 0xC0, 0x03, 0xC0, 0x03, 0xC0, 0x0E, 0x70, 0xFC, 0x3F, 0xF0, 0x0F},
    //1
    {0x00, 0xC0, 0x30, 0xC0, 0x30, 0xC0, 0x0C, 0xC0, 0x0C, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xC0, 0x00, 0xC0, 0x00, 0xC0, 0x00, 0xC0, 0x00, 0xC0},
    //2
    {0x0C, 0xF0, 0x0C, 0xF0, 0x03, 0xCC, 0x03, 0xCC, 0x03, 0xC3, 0x03, 0xC3, 0x03, 0xC3, 0x03, 0xC3, 0xC3, 0xC0, 0xC3, 0xC0, 0x3C, 0xC0, 0x3C, 0xC0},
    //3
    {0x0C, 0x30, 0x0C, 0x30, 0x03, 0xC0, 0x03, 0xC0, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x7C, 0x3E, 0x7C, 0x3E},
    //4
    {0x00, 0x0F, 0xC0, 0x0F, 0xF0, 0x0C, 0x3C, 0x0C, 0x0C, 0x0C, 0x0F, 0x0C, 0x03, 0x0C, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x0C, 0x00, 0x0C, 0x00, 0x0C},
    //5
    {0xFF, 0x30, 0xFF, 0x70, 0x83, 0x60, 0x83, 0xC0, 0xC3, 0x80, 0xC3, 0x80, 0xC3, 0x80, 0xC3, 0x80, 0x83, 0xC1, 0x83, 0x61, 0x03, 0x77, 0x00, 0x1C},
    //6
    {0xF0, 0x1F, 0xFC, 0x3F, 0x0C, 0x63, 0x83, 0x63, 0xC3, 0xC0, 0xC3, 0xC0, 0xC3, 0xC0, 0xC3, 0xC0, 0x83, 0x61, 0x8E, 0x61, 0x0C, 0x3F, 0x00, 0x1E},
    //7
    {0x0F, 0x00, 0x3F, 0x00, 0x33, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0xC0, 0x03, 0xF0, 0x03, 0x3C, 0x03, 0x0F, 0xC3, 0x03, 0xFF, 0x00, 0x3F, 0x00},
    //8
    {0x3C, 0x3C, 0x3C, 0x3C, 0x63, 0xC3, 0x63, 0xC3, 0xC3, 0xC1, 0xC3, 0xC1, 0xC3, 0xC1, 0xC3, 0xC1, 0x63, 0xC3, 0x63, 0xC3, 0x3C, 0x3C, 0x3C, 0x3C},
    //9
    {0x7C, 0x18, 0xFE, 0x70, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0x83, 0xC1, 0xFE, 0x7F, 0xF8, 0x1F},
};
const uint8_t dot[] = {0x00, 0xC0, 0x00, 0xC0};

//alphabet
const uint8_t b[] = {0x00, 0x00, 0x00, 0xFF, 0x00, 0x89, 0x00, 0x89, 0x00, 0x89, 0x00, 0x76, 0x00, 0x00, 0x00, 0x00};
const uint8_t p[] = {0x00, 0xFF, 0x00, 0x09, 0x00, 0x09, 0x00, 0x09, 0x00, 0x09, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00};
const uint8_t m[] = {0x00, 0xFF, 0x00, 0x02, 0x00, 0x0C, 0x00, 0x10, 0x00, 0x10, 0x00, 0x0C, 0x00, 0x02, 0x00, 0xFF};

// I2C Communication Functions
void I2C_Start() {
    GIE = 0;
    I2C_Wait();
    SEN = 1;            // Initiate start condition
}

void I2C_Wait() {
    while ((SSPSTAT & 0x04) || (SSPCON2 & 0x1F));
}

void I2C_Stop() {
    I2C_Wait();
    PEN = 1;            // Initiate stop condition
    GIE = 1;
}

void I2C_Write(uint8_t data) {
    I2C_Wait();
    SSPBUF = data;      // Load data into buffer
}

//Page for row(1 Page = 8 Row), Column for column
void OLED_SetPageAndColumnAddress(const uint8_t startPage, const uint8_t endPage, const uint8_t startColumn, const uint8_t endColumn) {
    I2C_Start();
    I2C_Write(OLED_ADDRESS << 1);
    I2C_Write(0x00);
    I2C_Write(0x22);
    I2C_Write(startPage);
    I2C_Write(endPage);
    I2C_Write(0x21);
    I2C_Write(startColumn);
    I2C_Write(endColumn);
    I2C_Stop();
}

// OLED Clear Screen
void OLED_Clear() {
    OLED_SetPageAndColumnAddress(0x00, 0x03, 0x00, 0x7F);
    
    I2C_Start();
    I2C_Write(OLED_ADDRESS << 1);
    I2C_Write(0x40);
    for(uint16_t cnt=0; cnt<512; cnt++){
        I2C_Write(0x00);
    }
    I2C_Stop();
}

//OLED Print Bitmap
void OLED_Print(const uint8_t startPage, const uint8_t endPage, const uint8_t startColumn, const uint8_t endColumn, const uint8_t *bitmap, uint16_t bitmapSize) {
    OLED_SetPageAndColumnAddress(startPage, endPage, startColumn, endColumn);

    I2C_Start();
    I2C_Write(OLED_ADDRESS << 1); // Write mode
    I2C_Write((uint8_t)0x40);              //Control byte, next are data
    for(uint16_t cnt=0; cnt<bitmapSize; cnt++) {    //Loop into bitmap data...
        I2C_Write(*bitmap);
        bitmap++;
    }
    I2C_Stop();
}

// OLED Write Character 
void OLED_PrintChar(const uint8_t startPage, const uint8_t endPage, const uint8_t startColumn, const uint8_t endColumn, char c) {
    if(c == '.'){
        OLED_Print(startPage, endPage, startColumn, endColumn, dot, sizeof(dot));
    }
    else if(c == 'b'){
        OLED_Print(startPage, endPage, startColumn, endColumn, b, sizeof(b));
    }
    else if(c == 'p'){
        OLED_Print(startPage, endPage, startColumn, endColumn, p, sizeof(p));
    }
    else if(c == 'm'){
        OLED_Print(startPage, endPage, startColumn, endColumn, m, sizeof(m));
    }
    else{
        uint8_t which_to_print = c - '0';
        OLED_Print(startPage, endPage, startColumn, endColumn, number[which_to_print], sizeof(number[which_to_print]));
    }
}

// OLED Write Number
void OLED_PrintNumber(const uint8_t startPage, const uint8_t endPage, const uint8_t startColumn, const uint8_t endColumn, const char* str) {
    uint8_t column = startColumn;
    while (*str) {
        OLED_PrintChar(startPage, endPage, column, endColumn, *str);
        if(*str == '.'){
            column += 4;//for dot (2-pixel width + 2-pixel space); 
        }
        else{
            column += 14;// Move to next number position (12-pixel width + 2-pixel space)
        }
        str++;
        if (column > 127) break; // Prevent overflow on the 128-pixel wide screen
    }
}